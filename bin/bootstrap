#!/usr/bin/env ruby
# frozen_string_literal: true

ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../Gemfile", __dir__)

require "bundler/setup"
require "sshkit"
require "sshkit/dsl"
require_relative "../lib/clawkit"

include SSHKit::DSL

Clawkit.load_env
config = Clawkit.load_config
ssh_user = config.fetch("ssh_user", "debian")
hosts = Clawkit.resolve_hosts(config)

servers = hosts.map { |host| SSHKit::Host.new("#{ssh_user}@#{host}") }

on servers do |host|
  info "Installing rsync..."
  execute :sudo, "apt-get", "update", "-qq"
  execute :sudo, "apt-get", "install", "-y", "-qq", "rsync"
  info "Done."
end

puts "Bootstrap complete."
